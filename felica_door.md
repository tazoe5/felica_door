# Felicaタッチ式オートロックを作ろう

- **Date:** 02/20 (木)



## 目的

- 家の鍵，いちいち開けるのだるい

- 時代がIoTだのデジタルだの言われている

  

- <h3>Suica (つまり，iPhone)で家が開けばかっこよくない？？？？</h3>

- あとシンプルに電子工作経験が全然なかったから．つまり暇だった．



## 買い出し

秋葉原の秋月電子通商などで購入![IMG_6631](/Users/tazoe/tazoWork/felica_door/img/IMG_6631.JPG)

- **ESP-WROOM-02 開発ボード (ESP8622)**
  - 技適済みでwi-fiにも接続できる優れもの
  - Bluetoothも欲しい人は ESP32 を買うといいと思う

- **RC-S620S (FeliCaカードリーダー)**
  - ブレッドボードに繋ぐためのピッチ変換基盤 + フラットケーブルも購入
- **SG92R (マイクロサーボ)**
  - 鍵のサムターンを回す (物理) のために使用
  - 100円強安いパワー小さめのサーボもあったけど，念のため強い方を購入
- ボタン (2つ)
  - サムターンを手動で回すのはだるいので，開け閉めボタンで制御してしまおうという発想
- ブレッドボード，ジャンパーワイヤほか
  - 適当に買った

後日使うかもと思ってこれら以外にも余分なものを買ってしまったので，総額7500円くらい？



## 工作開始

### 配線

久しぶりのハンダゴテに苦戦しながらもとりあえず仮組みしてイメージを掴む．

下の写真は仮組み途中で，まだ電源と繋げる前．

### ![IMG_6639](/Users/tazoe/tazoWork/felica_door/img/IMG_6639.JPG)



ブレッドボードに刺さらないスイッチを買ってしまった，購入時に何も見てないと言える

![IMG_6640](/Users/tazoe/tazoWork/felica_door/img/IMG_6640.JPG)

初心者中の初心者なので試行錯誤しながらやってたけどとりあえずできた．

RXDとTXDを雑に繋げば大丈夫でしょう，知らんけど．



## コーディング

ESP-8266を動作させるためには**Arduino IDE**なるものを使う必要があるらしい．

公式ページから最新版をダウンロードした．



FeliCaを読み込むためのRC-S620S用のライブラリが必要だそうなので，`~/Documents/Arduino/libraries/RC-S620S`を作成し，配下に配置した．

また，同ライブラリは2010年から更新されていないらしく，[ここ](https://deviceplus.jp/hobby/entry_f02/) を参考に一部コードの修正を行った．



#### ESP8266の起動確認とWi-Fi接続

何が起きているのか全然わからないけど動作の確認をしていく．

電源用にと思っていた別付けのMicro USBコネクタからの給電だとケーブル問題で耐えないことがわかったので，開発ボードに直接繋ぐことにする．

開発ボードのMicro USBコネクタとmacをケーブルで接続するだけでOK．下は光って嬉しいの図．

![IMG_6644](/Users/tazoe/tazoWork/felica_door/img/IMG_6644.JPG)

メニューから`ツール`> `シリアルモニタ` を開く．

起動確認の`AT`，バージョンチェックの `AT+GMR` ，IPアドレス/ Macアドレス確認の `AT+CIFSR`　が無事に動いていることがわかる．

![esp8266_test](/Users/tazoe/tazoWork/felica_door/img/esp8266_test.png)



次に家のWi-Fiへの接続を行う．先ほど同様シリアルモニタから ATコマンドで行う．

- **Wi-Fiモードを親機から子機へと変更**

``` 
AT+CWMODE=1
```

- **アクセスポイントリストの表示**
  - 家のアクセスポイントがちゃんと見つかった．

```
AT+CWLAP
```

- **アクセスポイントに接続**

```
AT+CWJAP="<接続先Wi-FiのSSID>","<password>"
```



## 参考ページ



> Arduino公式ページ https://www.arduino.cc/en/main/software

> RC-S620Sのライブラリ (Sony) http://blog.felicalauncher.com/sdk_for_air/?page_id=2699

> ライブラリのコード変更についての記事 https://deviceplus.jp/hobby/entry_f02/